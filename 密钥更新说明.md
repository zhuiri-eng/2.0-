# 🔑 Payma API密钥更新说明

## 📋 更新概述

**更新时间**: 2024年12月19日  
**更新类型**: 支付网关密钥更新  
**影响范围**: 所有支付相关功能

## 🔄 更新内容

### 旧配置
- **支付网关**: https://pay.payma.cn/
- **商户ID (PID)**: 145297917
- **商户密钥 (KEY)**: `677g7etdq4GTqFB11e6bah1aEh1AbBmb`

### 新配置
- **支付网关**: https://pay.payma.cn/
- **商户ID (PID)**: 145297917
- **商户密钥 (KEY)**: `AeYM3mCbR1NK420b9MZAY105yEm2ccbu`

## 📁 已更新的文件

### 核心支付文件
1. **`命理支付页面.html`** - 主支付页面
2. **`payment-api.js`** - 后端支付API
3. **`payment-system.html`** - 支付系统页面
4. **`index.html`** - 首页支付功能
5. **`命理支付.html`** - 命理支付页面

### 测试和调试文件
6. **`支付修复测试.html`** - 支付修复测试页面
7. **`签名测试.html`** - 签名生成测试
8. **`纯前端支付.html`** - 纯前端支付测试

### 文档和配置文件
9. **`README.md`** - 项目说明文档
10. **`netlify.toml`** - Netlify部署配置
11. **`package.json`** - 项目依赖配置

### 启动和说明文件
12. **`启动真实支付系统.bat`** - 启动脚本
13. **`快速启动指南.md`** - 快速启动说明
14. **`支付系统使用说明.md`** - 使用说明
15. **`真实支付使用说明.md`** - 真实支付说明
16. **`真实支付对接说明.md`** - 对接说明

## 🚀 部署方法

### 方法一：使用自动部署脚本
```bash
# 双击运行
部署更新.bat
```

### 方法二：手动部署到Netlify
1. 访问 https://app.netlify.com/
2. 点击 "New site from Git"
3. 选择您的Git仓库
4. 设置构建命令为空，发布目录为 "."
5. 点击 "Deploy site"

### 方法三：本地测试
```bash
# 安装依赖
npm install

# 启动本地服务器
npm start

# 或使用开发模式
npm run dev
```

## ✅ 验证步骤

### 1. 签名验证
- 打开 `签名测试.html`
- 输入测试参数
- 验证签名生成是否正确

### 2. 支付流程测试
- 打开 `命理支付页面.html`
- 选择支付方式
- 测试支付跳转是否正常

### 3. API测试
- 启动本地服务器
- 测试支付创建API
- 验证回调处理

## 🔧 技术细节

### 签名生成算法
```javascript
// 1. 按参数名排序
const sortedKeys = Object.keys(data).filter(key => key !== 'sign' && key !== 'sign_type').sort();

// 2. 构建签名字符串
let signStr = '';
sortedKeys.forEach(key => {
    if (data[key] !== '' && data[key] != null) {
        signStr += key + '=' + data[key] + '&';
    }
});

// 3. 添加密钥
signStr += 'key=' + PAYMA_CONFIG.key;

// 4. 生成MD5签名
return md5(signStr);
```

### 支付参数格式
```javascript
const paymentData = {
    pid: '145297917',           // 商户ID
    type: 'alipay',            // 支付类型
    out_trade_no: orderId,     // 订单号
    notify_url: callbackUrl,   // 异步通知地址
    return_url: returnUrl,     // 同步返回地址
    name: orderName,           // 商品名称
    money: amount,             // 支付金额
    sign_type: 'MD5'          // 签名类型
};
```

## ⚠️ 注意事项

1. **密钥安全**: 新密钥已更新到所有相关文件，请确保密钥安全
2. **测试环境**: 建议先在测试环境验证功能正常后再部署到生产环境
3. **回调地址**: 确保支付回调地址配置正确
4. **网络连接**: 确保服务器能够正常访问Payma API

## 🆘 故障排除

### 常见问题
1. **签名验证失败**: 检查密钥是否正确更新
2. **支付跳转失败**: 检查网络连接和API地址
3. **回调处理异常**: 检查回调地址配置

### 调试工具
- 使用浏览器开发者工具查看网络请求
- 检查控制台错误信息
- 使用 `签名测试.html` 验证签名生成

## 📞 技术支持

如果遇到问题，请检查：
1. 所有文件是否已正确更新
2. 网络连接是否正常
3. Payma商户后台配置是否正确

---

**更新完成时间**: 2024年12月19日  
**更新状态**: ✅ 已完成  
**部署状态**: 🔄 待部署
