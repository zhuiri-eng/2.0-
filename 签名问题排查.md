# 🔍 Payma签名校验失败问题排查

## ❌ 错误信息
```
站点提示信息
sign签名校验失败!
```

## 🔍 可能的问题原因

### 1. 参数名称问题
Payma可能要求特定的参数名称，我们需要确认：

**当前使用的参数：**
- `pid` - 商户ID
- `type` - 支付方式
- `out_trade_no` - 订单号
- `notify_url` - 异步通知地址
- `return_url` - 同步返回地址
- `name` - 商品名称
- `money` - 金额
- `sign_type` - 签名类型
- `sign` - 签名

**可能的问题：**
- 参数名称可能应该是 `trade_no` 而不是 `out_trade_no`
- 参数名称可能应该是 `amount` 而不是 `money`
- 参数名称可能应该是 `subject` 而不是 `name`

### 2. 参数值格式问题
- 金额格式：可能需要是整数（分）而不是小数（元）
- 订单号格式：可能需要特定格式
- 时间戳：可能需要添加时间戳参数

### 3. 签名算法问题
- 参数排序可能不正确
- 签名字符串拼接可能有问题
- MD5算法实现可能有问题

## 🛠️ 解决方案

### 方案1：修正参数名称
```javascript
// 尝试不同的参数名称组合
const paymentData = {
    pid: '145297917',
    type: 'alipay',
    trade_no: orderId,        // 尝试 trade_no 而不是 out_trade_no
    amount: amount,           // 尝试 amount 而不是 money
    subject: orderName,       // 尝试 subject 而不是 name
    notify_url: notifyUrl,
    return_url: returnUrl,
    sign_type: 'MD5'
};
```

### 方案2：修正金额格式
```javascript
// 将金额转换为分
const amountInCents = Math.round(parseFloat(amount) * 100);
const paymentData = {
    // ... 其他参数
    money: amountInCents.toString(),  // 使用分为单位
    // 或者
    amount: amountInCents.toString(),
};
```

### 方案3：添加时间戳
```javascript
const paymentData = {
    // ... 其他参数
    timestamp: Math.floor(Date.now() / 1000).toString(),
};
```

### 方案4：修正签名算法
```javascript
function generateSign(data) {
    // 确保参数按字母顺序排序
    const sortedKeys = Object.keys(data)
        .filter(key => key !== 'sign' && key !== 'sign_type')
        .sort();
    
    let signStr = '';
    sortedKeys.forEach(key => {
        if (data[key] !== '' && data[key] != null && data[key] !== undefined) {
            signStr += key + '=' + data[key] + '&';
        }
    });
    signStr += 'key=' + PAYMA_KEY;
    
    console.log('签名字符串:', signStr); // 调试用
    return md5(signStr);
}
```

## 🧪 测试步骤

### 1. 创建测试页面
创建一个简单的测试页面，尝试不同的参数组合：

```html
<!DOCTYPE html>
<html>
<head>
    <title>Payma签名测试</title>
</head>
<body>
    <h1>Payma签名测试</h1>
    <button onclick="testPayment()">测试支付</button>
    <div id="result"></div>
    
    <script>
        function testPayment() {
            // 测试不同的参数组合
            const testCases = [
                {
                    name: "原始参数",
                    data: {
                        pid: '145297917',
                        type: 'alipay',
                        out_trade_no: 'TEST' + Date.now(),
                        name: '测试商品',
                        money: '0.01',
                        sign_type: 'MD5'
                    }
                },
                {
                    name: "修正参数名",
                    data: {
                        pid: '145297917',
                        type: 'alipay',
                        trade_no: 'TEST' + Date.now(),
                        subject: '测试商品',
                        amount: '1', // 1分钱
                        sign_type: 'MD5'
                    }
                }
            ];
            
            testCases.forEach((testCase, index) => {
                setTimeout(() => {
                    console.log(`测试 ${testCase.name}:`, testCase.data);
                    submitPayment(testCase.data);
                }, index * 2000);
            });
        }
        
        function submitPayment(data) {
            // 生成签名
            data.sign = generateSign(data);
            
            // 提交表单
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'https://pay.payma.cn/submit.php';
            form.target = '_blank';
            
            Object.keys(data).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = data[key];
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }
    </script>
</body>
</html>
```

### 2. 联系Payma技术支持
如果以上方案都不行，建议：
- 查看Payma官方API文档
- 联系Payma技术支持
- 确认正确的参数格式和签名算法

### 3. 使用Payma提供的SDK
如果有官方SDK，建议使用官方SDK而不是自己实现签名算法。

## 📞 下一步行动

1. **立即测试**：创建测试页面，尝试不同的参数组合
2. **查看文档**：查找Payma的官方API文档
3. **联系支持**：如果问题持续，联系Payma技术支持
4. **备用方案**：考虑使用其他支付网关

## 🔗 相关资源

- Payma官方文档：[https://pay.payma.cn/](https://pay.payma.cn/)
- MD5算法验证：[在线MD5计算器](https://www.md5hashgenerator.com/)
- 支付API测试工具：[Postman](https://www.postman.com/) 