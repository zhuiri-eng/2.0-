# 🚀 自动化收款系统使用说明

## 📋 系统概述

本系统是一个完整的自动化收款解决方案，集成了Payma支付网关，支持多种支付方式，包括支付宝、微信支付、QQ钱包和银联支付。

## 🛠️ 系统架构

### 前端页面
- `payment-system.html` - 支付创建页面
- `order-management.html` - 订单管理页面

### 后端API
- `payment-api.js` - 支付API服务器
- `package.json` - 项目依赖配置

## 🚀 快速启动

### 方法一：使用批处理文件（推荐）
1. 双击运行 `启动支付系统.bat`
2. 系统会自动检查环境、安装依赖并启动服务器
3. 浏览器会自动打开API健康检查页面

### 方法二：手动启动
```bash
# 1. 安装依赖
npm install

# 2. 启动服务器
node payment-api.js
```

## 📱 访问页面

启动成功后，可以通过以下地址访问：

- **支付页面**: 直接打开 `payment-system.html`
- **订单管理**: 直接打开 `order-management.html`
- **API健康检查**: http://localhost:3000/api/health

## 💳 支付配置

系统已预配置Payma支付参数：

- **支付网关**: https://pay.payma.cn/
- **商户ID (PID)**: 145297917
- **商户密钥 (KEY)**: 677g7etdq4GTqFB11e6bah1aEh1AbBmb

## 🔧 API接口说明

### 1. 创建支付订单
```
POST /api/create-payment
Content-Type: application/json

{
    "amount": "100.00",
    "orderName": "测试商品",
    "orderId": "ORDER123456789",
    "paymentMethod": "alipay"
}
```

### 2. 支付回调通知
```
POST /api/payment-notify
```
Payma支付网关会向此接口发送支付结果通知

### 3. 支付返回页面
```
GET /api/payment-return
```
用户支付完成后跳转的页面

### 4. 查询订单状态
```
GET /api/order-status/:orderId
```

### 5. 获取订单列表
```
GET /api/orders
```

### 6. 健康检查
```
GET /api/health
```

## 📊 功能特性

### 支付创建页面
- ✅ 支持多种支付方式选择
- ✅ 自动生成订单号
- ✅ 实时金额验证
- ✅ 支付二维码生成
- ✅ 支付链接跳转
- ✅ 响应式设计

### 订单管理页面
- ✅ 实时订单统计
- ✅ 订单状态筛选
- ✅ 订单详情查看
- ✅ 订单状态检查
- ✅ 自动数据刷新
- ✅ 移动端适配

### 后端API
- ✅ MD5签名验证
- ✅ 支付回调处理
- ✅ 订单状态管理
- ✅ 错误处理机制
- ✅ CORS跨域支持

## 🔒 安全特性

1. **签名验证**: 所有支付请求都使用MD5签名验证
2. **参数验证**: 严格的输入参数验证
3. **错误处理**: 完善的错误处理机制
4. **日志记录**: 详细的支付日志记录

## 📱 支持的支付方式

- 💰 **支付宝** (alipay)
- 💚 **微信支付** (wechat)
- 💙 **QQ钱包** (qqpay)
- 💳 **银联支付** (unionpay)

## 🛠️ 开发说明

### 环境要求
- Node.js >= 14.0.0
- npm >= 6.0.0

### 依赖包
- express: Web框架
- axios: HTTP客户端
- cors: 跨域支持
- crypto: 加密模块

### 开发模式
```bash
# 使用nodemon进行开发（自动重启）
npm run dev
```

## 🔧 自定义配置

### 修改支付配置
在 `payment-api.js` 中修改 `PAYMA_CONFIG` 对象：

```javascript
const PAYMA_CONFIG = {
    apiUrl: 'https://pay.payma.cn/',
    pid: '你的商户ID',
    key: '你的商户密钥'
};
```

### 修改服务器端口
```javascript
const PORT = process.env.PORT || 3000; // 修改默认端口
```

## 📝 部署说明

### 本地部署
1. 确保Node.js环境已安装
2. 运行 `npm install` 安装依赖
3. 运行 `node payment-api.js` 启动服务器
4. 访问支付页面进行测试

### 服务器部署
1. 上传代码到服务器
2. 安装Node.js环境
3. 运行 `npm install --production`
4. 使用PM2或forever等工具启动服务
5. 配置反向代理（如Nginx）

### 生产环境注意事项
- 使用HTTPS协议
- 配置防火墙规则
- 设置日志轮转
- 配置监控告警
- 定期备份数据

## 🐛 故障排除

### 常见问题

1. **端口被占用**
   ```
   错误: listen EADDRINUSE :::3000
   解决: 修改端口号或关闭占用端口的程序
   ```

2. **依赖安装失败**
   ```
   解决: 清除npm缓存后重新安装
   npm cache clean --force
   npm install
   ```

3. **跨域问题**
   ```
   解决: 确保CORS配置正确，或使用代理服务器
   ```

4. **支付回调失败**
   ```
   检查: 回调URL是否可访问，签名是否正确
   ```

### 日志查看
服务器运行时会输出详细的日志信息，包括：
- 支付请求日志
- 回调处理日志
- 错误信息日志

## 📞 技术支持

如遇到问题，请检查：
1. Node.js版本是否符合要求
2. 网络连接是否正常
3. 支付配置是否正确
4. 服务器日志是否有错误信息

## 📄 许可证

MIT License - 可自由使用和修改

---

**注意**: 本系统仅用于学习和测试目的，生产环境使用前请确保符合相关法律法规和支付行业规范。 