# 🔗 真实支付API对接说明

## 📋 支付配置信息

- **支付网关**: https://pay.payma.cn/
- **商户ID (PID)**: 145297917
- **商户密钥 (KEY)**: AeYM3mCbR1NK420b9MZAY105yEm2ccbu

## 🚀 快速启动

### 方法一：使用批处理文件（推荐）
1. 双击运行 `启动真实支付系统.bat`
2. 等待服务器启动完成
3. 访问测试页面：http://localhost:3000/real-payment-test.html

### 方法二：手动启动
```bash
# 安装依赖
npm install

# 启动服务器
npm start
```

## 📁 文件说明

### 核心文件
- `payment-api.js` - 支付API服务器
- `real-payment-test.html` - 真实支付测试页面
- `payment-system.html` - 完整支付系统页面

### 配置文件
- `package.json` - 项目依赖配置
- `启动真实支付系统.bat` - 一键启动脚本

## 🔧 API接口说明

### 1. 创建支付订单
```
POST /api/create-payment
Content-Type: application/json

{
    "amount": "0.01",
    "orderName": "测试商品",
    "orderId": "ORDER123456789",
    "paymentMethod": "alipay"
}
```

**响应示例：**
```json
{
    "success": true,
    "code": 1,
    "msg": "支付订单创建成功",
    "data": {
        "trade_no": "PAY20231201123456789",
        "out_trade_no": "ORDER123456789",
        "money": "0.01",
        "pay_url": "https://pay.payma.cn/pay/...",
        "qr_code": "https://api.qrserver.com/v1/create-qr-code/..."
    }
}
```

### 2. 支付回调通知
```
POST /api/payment-notify
```
Payma支付平台会向此地址发送支付结果通知

### 3. 支付返回页面
```
GET /api/payment-return
```
用户支付完成后跳转的页面

### 4. 查询订单状态
```
GET /api/order-status/:orderId
```

### 5. 获取所有订单
```
GET /api/orders
```

### 6. 健康检查
```
GET /api/health
```

## 💳 支持的支付方式

- **alipay** - 支付宝
- **wechat** - 微信支付
- **qqpay** - QQ钱包
- **unionpay** - 银联支付

## 🔐 安全说明

### 签名验证
系统使用MD5签名验证支付回调的真实性：

1. 按参数名排序
2. 构建签名字符串：`key1=value1&key2=value2&...&key=商户密钥`
3. 计算MD5哈希值
4. 与回调中的sign参数比对

### 回调验证
- 验证签名确保数据来源可信
- 检查订单状态避免重复处理
- 记录详细日志便于排查问题

## 📊 测试流程

1. **启动服务器**
   ```bash
   npm start
   ```

2. **访问测试页面**
   - 打开浏览器访问：http://localhost:3000/real-payment-test.html

3. **创建测试订单**
   - 输入支付金额（建议0.01元测试）
   - 选择支付方式
   - 点击"创建真实支付"

4. **完成支付**
   - 使用对应的支付方式完成支付
   - 系统会自动接收支付回调
   - 订单状态会更新为"已支付"

## 🐛 常见问题

### 1. 服务器启动失败
- 检查Node.js是否安装：`node --version`
- 检查端口3000是否被占用
- 检查依赖是否安装：`npm install`

### 2. 支付创建失败
- 检查网络连接
- 验证商户ID和密钥是否正确
- 查看服务器日志获取详细错误信息

### 3. 支付回调不接收
- 确保服务器能正常访问
- 检查回调地址是否正确
- 验证签名算法是否正确

### 4. 订单状态不更新
- 检查支付回调处理逻辑
- 查看服务器日志
- 确认Payma平台回调正常

## 📝 日志说明

系统会记录详细的日志信息：
- 支付订单创建过程
- 签名验证结果
- 支付回调处理
- 错误信息记录

日志格式：`[时间戳] [级别] 消息内容`

## 🔄 部署说明

### 本地开发
- 直接运行 `npm start`
- 访问 http://localhost:3000

### 生产环境
1. 配置域名和SSL证书
2. 修改回调地址为公网地址
3. 使用PM2等工具管理进程
4. 配置防火墙和安全策略

## 📞 技术支持

如遇到问题，请检查：
1. 服务器日志输出
2. 网络连接状态
3. Payma平台配置
4. 签名算法实现

---

**注意**: 本系统仅用于测试和开发，生产环境请根据实际需求进行安全加固和优化。 